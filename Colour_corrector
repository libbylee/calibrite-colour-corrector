import sys
import numpy as np
import pandas as pd
import os

sys.path.append(os.path.join(os.path.dirname(__file__), 'references'))
from references.reference_values import colour_checker_lab_reference

print("started!")

def load_measured_colorchecker(csv_path):
    """ Loads measured ColourChecker L*a*b values from a CSV file.
    
    Expected CSV format (from Colour_extractor):
    Patch,Color_Name,L*,a*,b*
    A1,Dark skin,47.84,6.00,-3.00
    B1,Light skin,79.61,5.00,-3.00
    ...
    
    Values should be in the same order as reference values (A1-F4).
    """

    print(f"Loading measured ColourChecker values from: {csv_path}")

    df = pd.read_csv(csv_path)

    # Check if we have the expected format with Patch and Color_Name columns
    if 'Patch' in df.columns and 'Color_Name' in df.columns:
        print(f"✓ Found ColorChecker format with patch labels")
        # Extract L*, a*, b* columns (exact match)
        if 'L*' in df.columns and 'a*' in df.columns and 'b*' in df.columns:
            l_col = 'L*'
            a_col = 'a*'
            b_col = 'b*'
        else:
            # Fall back to finding columns with 'l', 'a', 'b' in their names
            l_col = [col for col in df.columns if 'l' in col.lower()][0]
            a_col = [col for col in df.columns if 'a' in col.lower()][0]
            b_col = [col for col in df.columns if 'b' in col.lower()][0]
    else:
        # Fall back to finding columns with 'l', 'a', 'b' in their names
        l_col = [col for col in df.columns if 'l' in col.lower()][0]
        a_col = [col for col in df.columns if 'a' in col.lower()][0]
        b_col = [col for col in df.columns if 'b' in col.lower()][0]

    measured_lab = df[[l_col, a_col, b_col]].values

    print(f"Loaded {len(measured_lab)} measurements")

    if len(measured_lab) != 24:
        print(f"⚠ WARNING: Expected 24 patches but got {len(measured_lab)}")
        print("Make sure measurements are in correct order from A1-F4")

    # Display first and last patches for verification
    if 'Patch' in df.columns:
        print(f"\nFirst patch: {df.iloc[0]['Patch']} ({df.iloc[0]['Color_Name']})")
        print(f"  L*={df.iloc[0][l_col]:.2f}, a*={df.iloc[0][a_col]:.2f}, b*={df.iloc[0][b_col]:.2f}")
        print(f"Last patch:  {df.iloc[-1]['Patch']} ({df.iloc[-1]['Color_Name']})")
        print(f"  L*={df.iloc[-1][l_col]:.2f}, a*={df.iloc[-1][a_col]:.2f}, b*={df.iloc[-1][b_col]:.2f}")

    return measured_lab

def calculate_correction(measured_lab, reference_lab):
    """
    Calculates the colour correction from measured and reference L*a*b* values
    Then returns the correction matrix 
    """

    print("\nCalculating correction...")

    reference_lab = np.array(reference_lab)
    measured_lab = np.array(measured_lab)

    # Calculate difference for each patch
    correction = reference_lab - measured_lab

    # Calculate average correction across all patches
    avg_correction = np.mean(correction, axis=0)
    
    # Calculate standard deviation to show variability
    std_correction = np.std(correction, axis=0)

    # Print results
    print("\n" + "="*60)
    print("CALIBRATION RESULTS")
    print("="*60)
    print(f"\nAverage Correction to Apply:")
    print(f"  ΔL*: {avg_correction[0]:+.2f} (±{std_correction[0]:.2f})")
    print(f"  Δa*: {avg_correction[1]:+.2f} (±{std_correction[1]:.2f})")
    print(f"  Δb*: {avg_correction[2]:+.2f} (±{std_correction[2]:.2f})")
    print("\nInterpretation:")
    if avg_correction[0] > 0:
        print(f"  - Image is {abs(avg_correction[0]):.1f} units too dark")
    else:
        print(f"  - Image is {abs(avg_correction[0]):.1f} units too bright")
    
    if avg_correction[1] > 0:
        print(f"  - Image has a green cast (shift red by {avg_correction[1]:.1f})")
    else:
        print(f"  - Image has a red cast (shift green by {abs(avg_correction[1]):.1f})")
    
    if avg_correction[2] > 0:
        print(f"  - Image has a blue cast (shift yellow by {avg_correction[2]:.1f})")
    else:
        print(f"  - Image has a yellow cast (shift blue by {abs(avg_correction[2]):.1f})")
    
    print("="*60)

    return avg_correction

def apply_correction_to_data(data_csv, correction, output_csv):
    """
    Apply correction to mussel L*a*b* measurements
    
    Input CSV should have L, a, b columns (and any other columns you want to keep)
    """
    print(f"\nLoading mussel data from: {data_csv}")
    df = pd.read_csv(data_csv)

    # Find L, a, b columns (handle both L* and L formats)
    l_cols = [col for col in df.columns if 'l' in col.lower()]
    a_cols = [col for col in df.columns if 'a' in col.lower()]
    b_cols = [col for col in df.columns if 'b' in col.lower()]
    
    if not l_cols or not a_cols or not b_cols:
        raise ValueError("Could not find L, a, b columns in the data!")
    
    l_col = l_cols[0]
    a_col = a_cols[0]
    b_col = b_cols[0]

    print(f"Found columns: {l_col}, {a_col}, {b_col}")

    # Apply correction
    df['L_corrected'] = df[l_col] + correction[0]
    df['a_corrected'] = df[a_col] + correction[1]
    df['b_corrected'] = df[b_col] + correction[2]

    # Save data
    df.to_csv(output_csv, index=False)
    print(f"✓ Corrected data saved to: {output_csv}")
    print(f"✓ Processed {len(df)} measurements")
    
    return df

def save_correction(correction, filename="correction_values.csv"):
    """Save correction values for future use"""
    corr_df = pd.DataFrame({
        'Parameter': ['L*', 'a*', 'b*'],
        'Correction': correction
    })
    corr_df.to_csv(filename, index=False)
    print(f"\n✓ Correction values saved to: {filename}")


def load_correction(filename="correction_values.csv"):
    """Load previously saved correction"""
    df = pd.read_csv(filename)
    correction = df['Correction'].values
    print(f"Loaded correction from: {filename}")
    print(f"  ΔL*: {correction[0]:+.2f}, Δa*: {correction[1]:+.2f}, Δb*: {correction[2]:+.2f}")
    return correction

def create_example_csvs():
    """Create example CSV files to show expected format"""
    
    # Example measured ColorChecker CSV (new format from Colour_extractor)
    measured_example = pd.DataFrame({
        'Patch': ['A1', 'B1', 'C1', 'D1', 'E1', 'F1',
                  'A2', 'B2', 'C2', 'D2', 'E2', 'F2',
                  'A3', 'B3', 'C3', 'D3', 'E3', 'F3',
                  'A4', 'B4', 'C4', 'D4', 'E4', 'F4'],
        'Color_Name': ['Dark skin', 'Light skin', 'Blue sky', 'Foliage', 'Blue flower', 'Bluish green',
                       'Orange', 'Purplish blue', 'Moderate red', 'Purple', 'Yellow green', 'Orange yellow',
                       'Blue', 'Green', 'Red', 'Yellow', 'Magenta', 'Cyan',
                       'White', 'Neutral 8', 'Neutral 6.5', 'Neutral 5', 'Neutral 3.5', 'Black'],
        'L*': [37.2, 64.5, 49.0, 43.2, 54.8, 70.2,
               62.5, 39.2, 50.3, 29.9, 71.5, 71.3,
               28.1, 54.2, 42.2, 81.5, 50.4, 49.3,
               94.9, 81.0, 66.7, 50.5, 35.4, 20.5],
        'a*': [14.5, 19.5, -3.9, -12.9, 9.8, -32.5,
               36.0, 10.9, 48.8, 22.7, -24.3, 18.4,
               15.6, -39.9, 51.2, 2.8, 51.5, -29.9,
               -1.1, -0.6, -0.8, -0.2, -0.5, 0.1],
        'b*': [15.1, 17.7, -22.7, 22.9, -24.9, -0.5,
               56.7, -45.3, 16.8, -20.9, 58.4, 67.5,
               -50.0, 32.5, 28.8, 80.6, -14.3, -28.5,
               2.9, 0.5, -0.1, 0.2, -0.5, -0.5]
    })
    measured_example.to_csv('example_measured_colorchecker.csv', index=False)
    
    # Example mussel data CSV
    mussel_example = pd.DataFrame({
        'Sample': ['Mussel_1_infested', 'Mussel_1_clean', 'Mussel_2_infested', 'Mussel_2_clean'],
        'Region': ['ROI1', 'ROI2', 'ROI1', 'ROI2'],
        'L*': [45.3, 52.1, 43.8, 51.5],
        'a*': [2.5, -1.2, 3.1, -0.8],
        'b*': [8.3, 5.2, 9.1, 5.8]
    })
    mussel_example.to_csv('example_mussel_data.csv', index=False)
    
    print("Created example CSV files:")
    print("  - example_measured_colorchecker.csv")
    print("  - example_mussel_data.csv")

# Main Workflow

if __name__ == "__main__":
    
    print("="*60)
    print("L*a*b* COLOR CALIBRATION TOOL")
    print("="*60)
    
    # File paths - UPDATE THESE
    colorchecker_measured_csv = "measured_colorchecker.csv"
    mussel_data_csv = "mussel_measurements.csv"
    corrected_output_csv = "mussel_measurements_corrected.csv"
    
    # Check if files exist
    if not os.path.exists(colorchecker_measured_csv):
        print(f"\n✗ ColorChecker measurements not found: {colorchecker_measured_csv}")
        print("\nCreating example files to show expected format...")
        create_example_csvs()
        print("\n" + "="*60)
        print("INSTRUCTIONS:")
        print("="*60)
        print("\n1. Run the Colour_extractor script:")
        print("   - Make sure your ColorChecker photo is positioned correctly")
        print("   - Top-left should be A1 (Dark skin)")
        print("   - Run: py Colour_extractor")
        print("   - This will create 'measured_colorchecker.csv'")
        print("\n2. Measure your mussels in Fiji:")
        print("   - Select regions of interest")
        print("   - Get L*a*b* values")
        print("   - Export as 'mussel_measurements.csv'")
        print("   - Make sure it has L*, a*, b* columns")
        print("\n3. Run this script again: py Colourcorrector")
        print("="*60)
        
    else:
        # Load measured ColorChecker values
        measured_lab = load_measured_colorchecker(colorchecker_measured_csv)
        
        # Calculate correction
        avg_correction = calculate_correction(
            measured_lab, 
            colour_checker_lab_reference
        )
        
        # Save correction for future use
        save_correction(avg_correction)
        
        # Apply to mussel data if available
        if os.path.exists(mussel_data_csv):
            corrected_df = apply_correction_to_data(
                mussel_data_csv,
                avg_correction,
                corrected_output_csv
            )
            print("\n✓ Calibration complete!")
        else:
            print(f"\n⚠ Mussel data not found: {mussel_data_csv}")
            print("Correction calculated and saved.")
            print("You can apply it to mussel data later.")
            import sys
import numpy as np
import pandas as pd
import os

sys.path.append(os.path.join(os.path.dirname(__file__), 'references'))
from references.reference_values import colour_checker_lab_reference

def load_measured_colorchecker(csv_path):
    """ Loads measured ColourChecker L*a*b values from a CSV file.
    
    Expected CSV format (from Colour_extractor):
    Patch,Color_Name,L*,a*,b*
    A1,Dark skin,47.84,6.00,-3.00
    B1,Light skin,79.61,5.00,-3.00
    ...
    
    Values should be in the same order as reference values (A1-F4).
    """

    print(f"Loading measured ColourChecker values from: {csv_path}")

    df = pd.read_csv(csv_path)

    # Check if we have the expected format with Patch and Color_Name columns
    if 'Patch' in df.columns and 'Color_Name' in df.columns:
        print(f"✓ Found ColorChecker format with patch labels")
        # Extract L*, a*, b* columns (exact match)
        if 'L*' in df.columns and 'a*' in df.columns and 'b*' in df.columns:
            l_col = 'L*'
            a_col = 'a*'
            b_col = 'b*'
        else:
            # Fall back to finding columns with 'l', 'a', 'b' in their names
            l_col = [col for col in df.columns if 'l' in col.lower()][0]
            a_col = [col for col in df.columns if 'a' in col.lower()][0]
            b_col = [col for col in df.columns if 'b' in col.lower()][0]
    else:
        # Fall back to finding columns with 'l', 'a', 'b' in their names
        l_col = [col for col in df.columns if 'l' in col.lower()][0]
        a_col = [col for col in df.columns if 'a' in col.lower()][0]
        b_col = [col for col in df.columns if 'b' in col.lower()][0]

    measured_lab = df[[l_col, a_col, b_col]].values

    print(f"Loaded {len(measured_lab)} measurements")

    if len(measured_lab) != 24:
        print(f"⚠ WARNING: Expected 24 patches but got {len(measured_lab)}")
        print("Make sure measurements are in correct order from A1-F4")

    # Display first and last patches for verification
    if 'Patch' in df.columns:
        print(f"\nFirst patch: {df.iloc[0]['Patch']} ({df.iloc[0]['Color_Name']})")
        print(f"  L*={df.iloc[0][l_col]:.2f}, a*={df.iloc[0][a_col]:.2f}, b*={df.iloc[0][b_col]:.2f}")
        print(f"Last patch:  {df.iloc[-1]['Patch']} ({df.iloc[-1]['Color_Name']})")
        print(f"  L*={df.iloc[-1][l_col]:.2f}, a*={df.iloc[-1][a_col]:.2f}, b*={df.iloc[-1][b_col]:.2f}")

    return measured_lab

def calculate_correction(measured_lab, reference_lab):
    """
    Calculates the colour correction from measured and reference L*a*b* values
    Then returns the correction matrix 
    """

    print("\nCalculating correction...")

    reference_lab = np.array(reference_lab)
    measured_lab = np.array(measured_lab)

    # Calculate difference for each patch
    correction = reference_lab - measured_lab

    # Calculate average correction across all patches
    avg_correction = np.mean(correction, axis=0)
    
    # Calculate standard deviation to show variability
    std_correction = np.std(correction, axis=0)

    # Print results
    print("\n" + "="*60)
    print("CALIBRATION RESULTS")
    print("="*60)
    print(f"\nAverage Correction to Apply:")
    print(f"  ΔL*: {avg_correction[0]:+.2f} (±{std_correction[0]:.2f})")
    print(f"  Δa*: {avg_correction[1]:+.2f} (±{std_correction[1]:.2f})")
    print(f"  Δb*: {avg_correction[2]:+.2f} (±{std_correction[2]:.2f})")
    print("\nInterpretation:")
    if avg_correction[0] > 0:
        print(f"  - Image is {abs(avg_correction[0]):.1f} units too dark")
    else:
        print(f"  - Image is {abs(avg_correction[0]):.1f} units too bright")
    
    if avg_correction[1] > 0:
        print(f"  - Image has a green cast (shift red by {avg_correction[1]:.1f})")
    else:
        print(f"  - Image has a red cast (shift green by {abs(avg_correction[1]):.1f})")
    
    if avg_correction[2] > 0:
        print(f"  - Image has a blue cast (shift yellow by {avg_correction[2]:.1f})")
    else:
        print(f"  - Image has a yellow cast (shift blue by {abs(avg_correction[2]):.1f})")
    
    print("="*60)

    return avg_correction

def apply_correction_to_data(data_csv, correction, output_csv):
    """
    Apply correction to mussel L*a*b* measurements
    
    Input CSV should have L, a, b columns (and any other columns you want to keep)
    """
    print(f"\nLoading mussel data from: {data_csv}")
    df = pd.read_csv(data_csv)

    # Find L, a, b columns (handle both L* and L formats)
    l_cols = [col for col in df.columns if 'l' in col.lower()]
    a_cols = [col for col in df.columns if 'a' in col.lower()]
    b_cols = [col for col in df.columns if 'b' in col.lower()]
    
    if not l_cols or not a_cols or not b_cols:
        raise ValueError("Could not find L, a, b columns in the data!")
    
    l_col = l_cols[0]
    a_col = a_cols[0]
    b_col = b_cols[0]

    print(f"Found columns: {l_col}, {a_col}, {b_col}")

    # Apply correction
    df['L_corrected'] = df[l_col] + correction[0]
    df['a_corrected'] = df[a_col] + correction[1]
    df['b_corrected'] = df[b_col] + correction[2]

    # Save data
    df.to_csv(output_csv, index=False)
    print(f"✓ Corrected data saved to: {output_csv}")
    print(f"✓ Processed {len(df)} measurements")
    
    return df

def save_correction(correction, filename="correction_values.csv"):
    """Save correction values for future use"""
    corr_df = pd.DataFrame({
        'Parameter': ['L*', 'a*', 'b*'],
        'Correction': correction
    })
    corr_df.to_csv(filename, index=False)
    print(f"\n✓ Correction values saved to: {filename}")


def load_correction(filename="correction_values.csv"):
    """Load previously saved correction"""
    df = pd.read_csv(filename)
    correction = df['Correction'].values
    print(f"Loaded correction from: {filename}")
    print(f"  ΔL*: {correction[0]:+.2f}, Δa*: {correction[1]:+.2f}, Δb*: {correction[2]:+.2f}")
    return correction

def create_example_csvs():
    """Create example CSV files to show expected format"""
    
    # Example measured ColorChecker CSV (new format from Colour_extractor)
    measured_example = pd.DataFrame({
        'Patch': ['A1', 'B1', 'C1', 'D1', 'E1', 'F1',
                  'A2', 'B2', 'C2', 'D2', 'E2', 'F2',
                  'A3', 'B3', 'C3', 'D3', 'E3', 'F3',
                  'A4', 'B4', 'C4', 'D4', 'E4', 'F4'],
        'Color_Name': ['Dark skin', 'Light skin', 'Blue sky', 'Foliage', 'Blue flower', 'Bluish green',
                       'Orange', 'Purplish blue', 'Moderate red', 'Purple', 'Yellow green', 'Orange yellow',
                       'Blue', 'Green', 'Red', 'Yellow', 'Magenta', 'Cyan',
                       'White', 'Neutral 8', 'Neutral 6.5', 'Neutral 5', 'Neutral 3.5', 'Black'],
        'L*': [37.2, 64.5, 49.0, 43.2, 54.8, 70.2,
               62.5, 39.2, 50.3, 29.9, 71.5, 71.3,
               28.1, 54.2, 42.2, 81.5, 50.4, 49.3,
               94.9, 81.0, 66.7, 50.5, 35.4, 20.5],
        'a*': [14.5, 19.5, -3.9, -12.9, 9.8, -32.5,
               36.0, 10.9, 48.8, 22.7, -24.3, 18.4,
               15.6, -39.9, 51.2, 2.8, 51.5, -29.9,
               -1.1, -0.6, -0.8, -0.2, -0.5, 0.1],
        'b*': [15.1, 17.7, -22.7, 22.9, -24.9, -0.5,
               56.7, -45.3, 16.8, -20.9, 58.4, 67.5,
               -50.0, 32.5, 28.8, 80.6, -14.3, -28.5,
               2.9, 0.5, -0.1, 0.2, -0.5, -0.5]
    })
    measured_example.to_csv('example_measured_colorchecker.csv', index=False)
    
    # Example mussel data CSV
    mussel_example = pd.DataFrame({
        'Sample': ['Mussel_1_infested', 'Mussel_1_clean', 'Mussel_2_infested', 'Mussel_2_clean'],
        'Region': ['ROI1', 'ROI2', 'ROI1', 'ROI2'],
        'L*': [45.3, 52.1, 43.8, 51.5],
        'a*': [2.5, -1.2, 3.1, -0.8],
        'b*': [8.3, 5.2, 9.1, 5.8]
    })
    mussel_example.to_csv('example_mussel_data.csv', index=False)
    
    print("Created example CSV files:")
    print("  - example_measured_colorchecker.csv")
    print("  - example_mussel_data.csv")

# Main Workflow

if __name__ == "__main__":
    
    print("="*60)
    print("L*a*b* COLOR CALIBRATION TOOL")
    print("="*60)
    
    # File paths - UPDATE THESE
    colorchecker_measured_csv = "measured_colorchecker.csv"
    mussel_data_csv = "mussel_measurements.csv"
    corrected_output_csv = "mussel_measurements_corrected.csv"
    
    # Check if files exist
    if not os.path.exists(colorchecker_measured_csv):
        print(f"\n✗ ColorChecker measurements not found: {colorchecker_measured_csv}")
        print("\nCreating example files to show expected format...")
        create_example_csvs()
        print("\n" + "="*60)
        print("INSTRUCTIONS:")
        print("="*60)
        print("\n1. Run the Colour_extractor script:")
        print("   - Make sure your ColorChecker photo is positioned correctly")
        print("   - Top-left should be A1 (Dark skin)")
        print("   - Run: py Colour_extractor")
        print("   - This will create 'measured_colorchecker.csv'")
        print("\n2. Measure your mussels in Fiji:")
        print("   - Select regions of interest")
        print("   - Get L*a*b* values")
        print("   - Export as 'mussel_measurements.csv'")
        print("   - Make sure it has L*, a*, b* columns")
        print("\n3. Run this script again: py Colourcorrector")
        print("="*60)
        
    else:
        # Load measured ColorChecker values
        measured_lab = load_measured_colorchecker(colorchecker_measured_csv)
        
        # Calculate correction
        avg_correction = calculate_correction(
            measured_lab, 
            colour_checker_lab_reference
        )
        
        # Save correction for future use
        save_correction(avg_correction)
        
        # Apply to mussel data if available
        if os.path.exists(mussel_data_csv):
            corrected_df = apply_correction_to_data(
                mussel_data_csv,
                avg_correction,
                corrected_output_csv
            )
            print("\n✓ Calibration complete!")
        else:
            print(f"\n⚠ Mussel data not found: {mussel_data_csv}")
            print("Correction calculated and saved.")
            print("You can apply it to mussel data later.")
            